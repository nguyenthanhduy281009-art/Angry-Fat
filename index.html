<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Angry Fat - Pro Sound & Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #87CEEB; touch-action: none; font-family: sans-serif; }
        canvas { display: block; }
        #ui { position: absolute; top: 15px; left: 20px; color: #2c3e50; pointer-events: none; }
        .btn-reset { position: absolute; top: 15px; right: 20px; padding: 10px 15px; background: #ff4757; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; z-index: 100; }
    </style>
</head>
<body>
    <button class="btn-reset" onclick="initLevel()">LÀM LẠI</button>
    <div id="ui">
        <h1 style="margin:0; font-size: 20px;">MÀN: <span id="lvl">1</span> | LƯỢT: <span id="birds-left">3</span></h1>
    </div>

<script>
const { Engine, Render, Runner, World, Bodies, Mouse, MouseConstraint, Constraint, Events, Composite, Sleeping, Vector } = Matter;

const engine = Engine.create();
const w = window.innerWidth, h = window.innerHeight;
const render = Render.create({
    element: document.body,
    engine: engine,
    options: { width: w, height: h, wireframes: false, background: '#87CEEB' }
});

Render.run(render);
Runner.run(Runner.create(), engine);

// --- ÂM THANH ---
const audioSling = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');
const audioFly = new Audio('https://assets.mixkit.co/active_storage/sfx/2012/2012-preview.mp3');
const audioHit = new Audio('https://assets.mixkit.co/active_storage/sfx/1044/1044-preview.mp3');

function playS(a) { a.currentTime = 0; a.play().catch(()=>{}); }

const BIRD_CAT = 0x0002, OBST_CAT = 0x0004;
let level = 1, shotsUsed = 0, currentBird = null, sling = null, targetGem = null;
const charImg = 'https://drive.google.com/thumbnail?id=1SGW0oc5yuw1WmArQ9GbNSQYBPbmXRWdi&sz=w500';
const slingPos = { x: w * 0.2, y: h * 0.7 };

const ground = Bodies.rectangle(w/2, h - 10, w, 60, { isStatic: true, friction: 1, render: { fillStyle: '#388e3c' } });
World.add(engine.world, ground);

function initLevel() {
    Composite.clear(engine.world, true);
    World.add(engine.world, ground);
    shotsUsed = 0;
    document.getElementById('birds-left').innerText = 3;
    document.getElementById('lvl').innerText = level;
    
    const tx = w * 0.6 + (Math.random() * w * 0.15);
    const opt = { friction: 1, density: 0.2, frictionStatic: 10, collisionFilter: { category: OBST_CAT } };
    
    // CHỌN KIỂU MAP NGẪU NHIÊN (1 trong 3 kiểu)
    const mapStyle = Math.floor(Math.random() * 3);

    if (mapStyle === 0) { 
        // KIỂU 1: Tháp cao 3 tầng (Ngọc ở giữa tầng 2)
        for (let i = 0; i < 3; i++) {
            const y = h - 80 - (i * 90);
            World.add(engine.world, [
                Bodies.rectangle(tx, y, 20, 80, opt),
                Bodies.rectangle(tx + 90, y, 20, 80, opt),
                Bodies.rectangle(tx + 45, y - 55, 160, 20, opt)
            ]);
            if (i === 1) { // Ngọc ở tầng giữa
                targetGem = Bodies.circle(tx + 45, y - 20, 22, { label: 'gem', render: { fillStyle: '#ffd700' } });
                World.add(engine.world, targetGem);
            }
        }
    } else if (mapStyle === 1) {
        // KIỂU 2: Tháp đôi (Ngọc kẹt giữa hai tháp)
        const y = h - 80;
        World.add(engine.world, [
            Bodies.rectangle(tx - 50, y, 20, 80, opt),
            Bodies.rectangle(tx + 20, y, 20, 80, opt),
            Bodies.rectangle(tx + 100, y, 20, 80, opt),
            Bodies.rectangle(tx + 170, y, 20, 80, opt),
            Bodies.rectangle(tx - 15, y - 55, 100, 20, opt),
            Bodies.rectangle(tx + 135, y - 55, 100, 20, opt)
        ]);
        targetGem = Bodies.circle(tx + 60, y, 22, { label: 'gem', render: { fillStyle: '#ffd700' } });
        World.add(engine.world, targetGem);
    } else {
        // KIỂU 3: Kim tự tháp đơn giản (Ngọc trên đỉnh cao nhất)
        const y1 = h - 80;
        const y2 = y1 - 90;
        World.add(engine.world, [
            Bodies.rectangle(tx, y1, 20, 80, opt),
            Bodies.rectangle(tx + 120, y1, 20, 80, opt),
            Bodies.rectangle(tx + 60, y1 - 55, 180, 20, opt),
            Bodies.rectangle(tx + 30, y2, 20, 80, opt),
            Bodies.rectangle(tx + 90, y2, 20, 80, opt),
            Bodies.rectangle(tx + 60, y2 - 55, 100, 20, opt)
        ]);
        targetGem = Bodies.circle(tx + 60, y2 - 90, 22, { label: 'gem', render: { fillStyle: '#ffd700' } });
        World.add(engine.world, targetGem);
    }

    spawnBird();
}
function spawnBird() {
    currentBird = Bodies.circle(slingPos.x, slingPos.y, 20, {
        density: 0.05, frictionAir: 0.01, restitution: 0.3,
        collisionFilter: { category: BIRD_CAT },
        render: { sprite: { texture: charImg, xScale: 0.2, yScale: 0.2 } }
    });
    Sleeping.set(currentBird, true);
    
    sling = Constraint.create({
        pointA: slingPos, bodyB: currentBird, 
        stiffness: 0.4, length: 0,
        render: { strokeStyle: '#4a2c02', lineWidth: 4 }
    });
    World.add(engine.world, [currentBird, sling]);
}


const mouse = Mouse.create(render.canvas);
const mConstraint = MouseConstraint.create(engine, {
    mouse: mouse, constraint: { stiffness: 0.8, render: { visible: false } }
});
render.mouse = mouse; 
mConstraint.collisionFilter.mask = BIRD_CAT;
World.add(engine.world, mConstraint);

Events.on(mConstraint, 'startdrag', (e) => {
    if (e.body === currentBird) {
        Sleeping.set(currentBird, false);
        playS(audioSling);
    }
});

Events.on(mConstraint, 'enddrag', (e) => { 
    if (e.body === currentBird) {
        const dist = Vector.magnitude(Vector.sub(currentBird.position, slingPos));
        if (dist > 25) {
            playS(audioFly);
            setTimeout(() => { if(sling) World.remove(engine.world, sling); }, 20);
            shotsUsed++;
            document.getElementById('birds-left').innerText = 3 - shotsUsed;
            setTimeout(() => { if (shotsUsed < 3 && targetGem) spawnBird(); }, 3500);
        }
    }
});

// Âm thanh va chạm
Events.on(engine, 'collisionStart', (event) => {
    event.pairs.forEach((pair) => { playS(audioHit); });
});

Events.on(engine, 'afterUpdate', () => {
    if (targetGem && targetGem.position.y > h - 100) {
        targetGem = null; level++; setTimeout(initLevel, 1000);
    }
});

initLevel();
window.addEventListener('resize', () => { location.reload(); });
</script>
</body>
</html>
