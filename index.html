<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Angry Fat - Fix Button</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; overflow: hidden; background: #0f0c29; position: fixed; width: 100vw; height: 100vh; font-family: sans-serif; }
        
        @media screen and (orientation: portrait) {
            body { width: 100vh; height: 100vw; transform: rotate(90deg); transform-origin: bottom left; position: absolute; top: -100vw; left: 0; }
        }

        #ui { position: absolute; top: 15px; left: 20px; color: white; pointer-events: none; z-index: 10; text-shadow: 2px 2px 5px #000; }
        .btn-reset { position: absolute; top: 15px; right: 20px; padding: 12px 20px; background: #ff4757; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; z-index: 100; }
        
        #reload-btn { 
            position: absolute; bottom: 25px; left: 30px; 
            width: 80px; height: 80px; border: 4px solid #f9ca24; border-radius: 50%; 
            background: rgba(255,255,255,0.2); display: flex; align-items: center; 
            justify-content: center; cursor: pointer; z-index: 1000; backdrop-filter: blur(10px);
            overflow: hidden; touch-action: auto;
        }
        #reload-btn img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; pointer-events: none; }
    </style>
</head>
<body>

    <button class="btn-reset" onclick="initLevel()">LÀM LẠI</button>
    <div id="ui"><h2>MÀN: <span id="lvl">1</span> | ĐẠN: <span id="birds-left">3</span></h2></div>
    
    <div id="reload-btn">
        <img src="https://drive.google.com/thumbnail?id=1SGW0oc5yuw1WmArQ9GbNSQYBPbmXRWdi&sz=w500">
    </div>

    <canvas id="bufferCanvas" style="display:none;"></canvas>

<script>
const { Engine, Render, Runner, World, Bodies, Mouse, MouseConstraint, Constraint, Events, Composite, Sleeping, Vector } = Matter;

const engine = Engine.create();
let w = Math.max(window.innerWidth, window.innerHeight);
let h = Math.min(window.innerWidth, window.innerHeight);

const render = Render.create({
    element: document.body,
    engine: engine,
    options: { width: w, height: h, wireframes: false, background: 'linear-gradient(to bottom, #1e3799, #0984e3)', pixelRatio: 1 }
});

Render.run(render);
Runner.run(Runner.create(), engine);

const BIRD_CAT = 0x0002, FLYING_CAT = 0x0008, OBST_CAT = 0x0004;
let level = 1, shotsUsed = 0, currentBird = null, sling = null, targetGem = null;
let slingPos = { x: 160, y: h * 0.75 };
let circularBirdTexture = '';

// Bo tròn ảnh nhân vật thành vòng tròn xoe
function createCircularTexture(url) {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = function() {
        const canvas = document.getElementById('bufferCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 200; canvas.height = 200;
        ctx.beginPath(); ctx.arc(100, 100, 100, 0, Math.PI * 2); ctx.clip();
        ctx.drawImage(img, 0, 0, 200, 200);
        circularBirdTexture = canvas.toDataURL();
        spawnBird();
    };
    img.src = url;
}
createCircularTexture('https://drive.google.com/thumbnail?id=1SGW0oc5yuw1WmArQ9GbNSQYBPbmXRWdi&sz=w500');

const mouse = Mouse.create(render.canvas);
const mConstraint = MouseConstraint.create(engine, {
    mouse: mouse,
    constraint: { stiffness: 0.6, render: { visible: false } }
});
mConstraint.collisionFilter.mask = BIRD_CAT;
render.mouse = mouse;
World.add(engine.world, mConstraint);

const ground = Bodies.rectangle(w/2, h - 15, w * 5, 30, { isStatic: true, label: 'ground', render: { fillStyle: '#2ed573' } });

function spawnBird() {
    if (currentBird || shotsUsed >= 3 || !circularBirdTexture) return;
    currentBird = Bodies.circle(slingPos.x, slingPos.y, 28, {
        density: 0.15, frictionAir: 0.005,
        collisionFilter: { category: BIRD_CAT },
        render: { sprite: { texture: circularBirdTexture, xScale: 0.28, yScale: 0.28 } }
    });
    sling = Constraint.create({
        pointA: slingPos, bodyB: currentBird, stiffness: 0.2, length: 0,
        render: { strokeStyle: '#f1c40f', lineWidth: 4 }
    });
    Sleeping.set(currentBird, true);
    World.add(engine.world, [currentBird, sling]);
}

function initLevel() {
    Composite.clear(engine.world, true);
    w = Math.max(window.innerWidth, window.innerHeight);
    h = Math.min(window.innerWidth, window.innerHeight);
    render.canvas.width = w; render.canvas.height = h;
    World.add(engine.world, [ground, mConstraint]);
    shotsUsed = 0; currentBird = null;
    document.getElementById('birds-left').innerText = 3;
    document.getElementById('lvl').innerText = level;

    const tx = w * 0.75;
    const groundY = h - 30;
    const opt = { friction: 1, density: 0.05, collisionFilter: { category: OBST_CAT } };
    
    // Tháp dưới đất cứng cáp
    World.add(engine.world, [
        Bodies.rectangle(tx - 45, groundY - 40, 20, 80, { ...opt, render: { fillStyle: '#d35400' } }),
        Bodies.rectangle(tx + 45, groundY - 40, 20, 80, { ...opt, render: { fillStyle: '#d35400' } }),
        Bodies.rectangle(tx, groundY - 90, 150, 20, { ...opt, render: { fillStyle: '#7f8c8d' } }),
        targetGem = Bodies.circle(tx, groundY - 130, 22, { label: 'gem', collisionFilter: { category: OBST_CAT }, render: { fillStyle: '#feca57' } })
    ]);
}

// SỬA LỖI NÚT BẤM: Dùng touchstart cho di động
document.getElementById('reload-btn').addEventListener('touchstart', (e) => {
    e.stopPropagation();
    spawnBird();
});
document.getElementById('reload-btn').addEventListener('click', spawnBird);

Events.on(mConstraint, 'startdrag', (e) => { if (e.body === currentBird) Sleeping.set(currentBird, false); });
Events.on(mConstraint, 'enddrag', (e) => { 
    if (e.body === currentBird) {
        if (Vector.magnitude(Vector.sub(currentBird.position, slingPos)) > 25) {
            currentBird.collisionFilter.category = FLYING_CAT;
            setTimeout(() => { if(sling) World.remove(engine.world, sling); sling = null; currentBird = null; }, 20);
            shotsUsed++;
            document.getElementById('birds-left').innerText = 3 - shotsUsed;
        }
    }
});

Events.on(engine, 'afterUpdate', () => {
    if (targetGem && (targetGem.position.y > h - 60 || targetGem.position.x > w || targetGem.position.x < 0)) {
        targetGem = null; level++; setTimeout(initLevel, 800);
    }
});

window.addEventListener('resize', initLevel);
initLevel();
// Chặn kéo trang nhưng không chặn UI
document.addEventListener('touchmove', (e) => { if(e.target.tagName !== 'BUTTON') e.preventDefault(); }, { passive: false });
</script>
</body>
</html>
