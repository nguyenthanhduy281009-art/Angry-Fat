<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Angry Fat - Fixed Logic</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { 
            margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; 
            height: 100vh; background: #1a1a1a; font-family: sans-serif; overflow: hidden; 
            touch-action: none;
        }
        canvas { max-width: 100vw; max-height: 100vh; object-fit: contain; }
        #ui { position: absolute; top: 10px; left: 15px; color: white; pointer-events: none; z-index: 10; }
        .btn-reset {
            position: absolute; top: 10px; right: 15px; padding: 8px 12px;
            background: #e74c3c; color: white; border: none; border-radius: 5px; 
            cursor: pointer; font-weight: bold; z-index: 20;
        }
    </style>
</head>
<body>
    <button class="btn-reset" onclick="initLevel()">RESET</button>
    <div id="ui">
        <h1 style="font-size: 16px; margin:0">LEVEL: <span id="lvl">1</span> | Lượt: <span id="birds-left">3</span></h1>
    </div>

<script>
const { Engine, Render, Runner, World, Bodies, Mouse, MouseConstraint, Constraint, Events, Composite } = Matter;

const engine = Engine.create();
const render = Render.create({
    element: document.body,
    engine: engine,
    options: { width: 1000, height: 600, wireframes: false, background: '#87CEEB' }
});

Render.run(render);
Runner.run(Runner.create(), engine);

const BIRD_CATEGORY = 0x0002;
const OBSTACLE_CATEGORY = 0x0004;

let level = 1, shotsUsed = 0, currentBird = null, sling = null, targetGem = null;
const charImg = 'https://drive.google.com/thumbnail?id=1SGW0oc5yuw1WmArQ9GbNSQYBPbmXRWdi&sz=w500';
const slingPos = { x: 200, y: 450 };

// Mặt đất
const ground = Bodies.rectangle(500, 580, 1000, 40, { isStatic: true, friction: 1, render: { fillStyle: '#2ecc71' } });
World.add(engine.world, ground);

function initLevel() {
    const all = Composite.allBodies(engine.world);
    all.forEach(b => { if(b !== ground) World.remove(engine.world, b); });
    if(sling) World.remove(engine.world, sling);

    shotsUsed = 0;
    document.getElementById('birds-left').innerText = 3;
    document.getElementById('lvl').innerText = level;

    // Xây tháp VỮNG CHẮC và BIẾN ĐỔI theo màn
    const tx = 600 + (Math.random() * 250); // Vị trí tháp thay đổi mỗi màn
    const layers = 2 + (level % 3); // Độ cao thay đổi mỗi màn
    
    for (let i = 0; i < layers; i++) {
        const y = 540 - (i * 85);
        // Tăng density (khối lượng) để gỗ nặng và vững hơn
        const opt = { 
            friction: 1, 
            density: 0.05, 
            frictionStatic: 10,
            collisionFilter: { category: OBSTACLE_CATEGORY } 
        };
        
        World.add(engine.world, [
            Bodies.rectangle(tx, y, 15, 80, opt),
            Bodies.rectangle(tx + 80, y, 15, 80, opt),
            Bodies.rectangle(tx + 40, y - 50, 140, 20, opt)
        ]);
        
        if (i === layers - 1) {
            targetGem = Bodies.circle(tx + 40, y - 90, 20, { 
                label: 'gem', 
                density: 0.001,
                collisionFilter: { category: OBSTACLE_CATEGORY },
                render: { fillStyle: '#f1c40f' } 
            });
            World.add(engine.world, targetGem);
        }
    }
    spawnBird();
}

function spawnBird() {
    // Tăng diện tích tiếp xúc (Bán kính 32) và Scale (0.32)
    currentBird = Bodies.circle(slingPos.x, slingPos.y, 32, {
        density: 0.02, // Làm nhân vật nặng hơn để húc đổ tháp cứng
        friction: 0.5,
        collisionFilter: { category: BIRD_CATEGORY },
        render: { 
            sprite: { texture: charImg, xScale: 0.32, yScale: 0.32 } 
        }
    });
    
    sling = Constraint.create({
        pointA: slingPos, bodyB: currentBird, stiffness: 0.1, length: 0,
        render: { strokeStyle: '#4a2c02', lineWidth: 4 }
    });
    World.add(engine.world, [currentBird, sling]);
}

const mouse = Mouse.create(render.canvas);
const mouseConstraint = MouseConstraint.create(engine, {
    mouse: mouse,
    constraint: { stiffness: 0.2, render: { visible: false } }
});
mouseConstraint.collisionFilter.mask = BIRD_CATEGORY;
World.add(engine.world, mouseConstraint);
render.mouse = mouse;

let firing = false;
Events.on(mouseConstraint, 'enddrag', (e) => { if (e.body === currentBird) firing = true; });

Events.on(engine, 'afterUpdate', () => {
    if (firing && currentBird.position.x > slingPos.x + 10) {
        World.remove(engine.world, sling);
        firing = false;
        shotsUsed++;
        document.getElementById('birds-left').innerText = 3 - shotsUsed;
        setTimeout(() => { if (shotsUsed < 3 && targetGem) spawnBird(); }, 3000);
    }

    // KIỂM TRA CHIẾN THẮNG: Chỉ cần ngọc rơi thấp hơn tháp hoặc chạm đất
    if (targetGem && targetGem.position.y > 530) {
        targetGem = null;
        level++;
        setTimeout(initLevel, 800);
    }
});

initLevel();
</script>
</body>
</html>
