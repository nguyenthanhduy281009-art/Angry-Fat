<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Angry Fat - Premium Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: sans-serif; }
        canvas { display: block; margin: auto; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #ui { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; }
    </style>
</head>
<body>
    <div id="ui">
        <h1 style="margin:0">ANGRY FAT</h1>
        <p>Kéo và thả để bắn | Lượt còn lại: <span id="birds-left">3</span></p>
    </div>

<script>
const { Engine, Render, Runner, World, Bodies, Mouse, MouseConstraint, Constraint, Composite, Events } = Matter;

const engine = Engine.create();
const render = Render.create({
    element: document.body,
    engine: engine,
    options: {
        width: 1200,
        height: 600,
        wireframes: false,
        background: 'linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%)'
    }
});

Render.run(render);
Runner.run(Runner.create(), engine);

// 1. Mặt đất và tường ngăn
const ground = Bodies.rectangle(600, 590, 1200, 40, { isStatic: true, render: { fillStyle: '#388E3C' } });
World.add(engine.world, ground);

// 2. Cấu hình nhân vật
const charImg = 'https://drive.google.com/thumbnail?id=1SGW0oc5yuw1WmArQ9GbNSQYBPbmXRWdi&sz=w200';
let birds = [];
let currentBirdIndex = 0;
const slingPos = { x: 250, y: 450 };

function createBird() {
    const bird = Bodies.circle(slingPos.x, slingPos.y, 25, {
        density: 0.006,
        restitution: 0.5,
        render: { sprite: { texture: charImg, xScale: 0.25, yScale: 0.25 } }
    });
    return bird;
}

// Khởi tạo chim đầu tiên
let currentBird = createBird();
World.add(engine.world, currentBird);

// 3. Ná cao su (Sling)
const sling = Constraint.create({
    pointA: slingPos,
    bodyB: currentBird,
    stiffness: 0.1,
    length: 0.1,
    render: { strokeStyle: '#5D4037', lineWidth: 8 }
});
World.add(engine.world, sling);

// 4. Cấu trúc lâu đài (Đẹp hơn)
function createStructure(x) {
    const boxes = [];
    for (let i = 0; i < 4; i++) { // Tầng
        const width = 40, height = 80;
        boxes.push(Bodies.rectangle(x, 540 - i * 90, width, height, { render: { fillStyle: '#795548' } }));
        boxes.push(Bodies.rectangle(x + 80, 540 - i * 90, width, height, { render: { fillStyle: '#795548' } }));
        boxes.push(Bodies.rectangle(x + 40, 490 - i * 90, 140, 20, { render: { fillStyle: '#A1887F' } }));
        // Thêm "Lợn" ở giữa
        if(i % 2 === 0) {
            boxes.push(Bodies.circle(x + 40, 540 - i * 90, 20, { render: { fillStyle: '#4CAF50' } }));
        }
    }
    return boxes;
}
World.add(engine.world, createStructure(800));

// 5. Điều khiển
const mouse = Mouse.create(render.canvas);
const mouseConstraint = MouseConstraint.create(engine, {
    mouse: mouse,
    constraint: { stiffness: 0.1, render: { visible: false } }
});
World.add(engine.world, mouseConstraint);

// Logic bắn và hồi nhân vật
let firing = false;
Events.on(mouseConstraint, 'enddrag', (e) => {
    if (e.body === currentBird) firing = true;
});

Events.on(engine, 'afterUpdate', () => {
    if (firing && currentBird.position.x > slingPos.x + 20) {
        // Thả chim cũ
        sling.bodyB = null;
        firing = false;
        
        // Chờ 3 giây để nạp chim mới
        setTimeout(() => {
            if (currentBirdIndex < 2) {
                currentBirdIndex++;
                document.getElementById('birds-left').innerText = 3 - currentBirdIndex;
                
                currentBird = createBird();
                World.add(engine.world, currentBird);
                sling.bodyB = currentBird;
            } else {
                alert("Hết lượt bắn! F5 để chơi lại.");
            }
        }, 3000);
    }
});
</script>
</body>
</html>
